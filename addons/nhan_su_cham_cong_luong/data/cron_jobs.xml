<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Cron job tự động tạo bảng chấm công đầu tháng -->
    <record id="cron_tao_bang_cham_cong_thang" model="ir.cron">
        <field name="name">Tạo bảng chấm công tháng mới</field>
        <field name="model_id" ref="model_bang_cham_cong_thang"/>
        <field name="state">code</field>
        <field name="code">
# Tạo bảng chấm công cho tháng hiện tại cho tất cả nhân viên
model.tao_bang_cham_cong_thang()
        </field>
        <field name="interval_number">1</field>
        <field name="interval_type">months</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
        <field name="user_id" ref="base.user_root"/>
    </record>

    <!-- Cron job tự động tạo bảng lương đầu tháng -->
    <record id="cron_tao_bang_luong_thang" model="ir.cron">
        <field name="name">Tạo bảng lương tháng mới</field>
        <field name="model_id" ref="model_bang_luong_thang"/>
        <field name="state">code</field>
        <field name="code">
# Tạo bảng lương cho tháng hiện tại cho tất cả nhân viên
model.tao_bang_luong_thang()
        </field>
        <field name="interval_number">1</field>
        <field name="interval_type">months</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
        <field name="user_id" ref="base.user_root"/>
    </record>

    <!-- Cron job tự động tính lương vào ngày 5 hàng tháng -->
    <record id="cron_tinh_luong_tu_dong" model="ir.cron">
        <field name="name">Tính lương tự động</field>
        <field name="model_id" ref="model_bang_luong_thang"/>
        <field name="state">code</field>
        <field name="code">
# Tự động tính lương cho các bảng lương ở trạng thái nháp
from datetime import date
current_date = date.today()

# Chỉ chạy vào ngày 5 hàng tháng
if current_date.day == 5:
    bang_luong_draft = model.search([
        ('trang_thai', '=', 'draft'),
        ('thang', '=', current_date.month),
        ('nam', '=', current_date.year)
    ])
    
    for bang_luong in bang_luong_draft:
        try:
            bang_luong.action_calculate()
        except Exception as e:
            # Log lỗi nhưng không dừng quá trình
            import logging
            _logger = logging.getLogger(__name__)
            _logger.error(f"Lỗi khi tính lương cho {bang_luong.nhan_vien_id.ho_va_ten}: {str(e)}")
        </field>
        <field name="interval_number">1</field>
        <field name="interval_type">days</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
        <field name="user_id" ref="base.user_root"/>
    </record>
</odoo>